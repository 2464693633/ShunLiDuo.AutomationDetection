# 顺利多自动化检测系统 - 项目结构文档

## 1. 项目概述

顺利多自动化检测系统是一个基于 WPF 的企业级自动化检测管理系统，采用 MVVM 架构模式，提供物流盒检测、规则管理、设备监控、用户权限管理等功能，并集成了 REST API 接口供外部系统（如 MES 系统）调用。

### 1.1 技术栈

- **框架**: .NET Framework 4.8
- **UI框架**: WPF (Windows Presentation Foundation)
- **架构模式**: MVVM (Model-View-ViewModel)
- **依赖注入容器**: Prism.DryIoc
- **UI组件库**: Material Design for WPF
- **数据库**: SQLite (System.Data.SQLite)
- **PLC通信**: S7.Net (Siemens S7 PLC)
- **串口通信**: System.IO.Ports (SerialPort)
- **Web API**: ASP.NET Web API SelfHost
- **Excel导出**: ClosedXML

### 1.2 核心功能

- 任务管理：物流盒检测任务分配与管理
- 规则管理：检测规则配置（物流盒与检测室匹配规则）
- 检测室管理：检测室配置、串口配置、PLC配置
- 检测记录：检测历史记录查询与导出
- 报警管理：设备报警记录与处理
- 用户权限管理：基于角色的访问控制（RBAC）
- 设备通信：PLC通信、串口扫码器通信
- REST API：提供外部系统接口（检测记录查询、任务管理）

---

## 2. 项目结构

```
ShunLiDuo.AutomationDetection/
├── Api/                          # REST API 控制器
│   └── Controllers/
│       ├── DetectionLogController.cs    # 检测记录API
│       ├── HomeController.cs            # 首页API
│       └── TaskController.cs            # 任务管理API
│
├── Converters/                   # 值转换器（数据绑定）
│   ├── BooleanToColorConverter.cs
│   ├── BooleanToConnectButtonTextConverter.cs
│   ├── BooleanToPlcStatusTextConverter.cs
│   ├── BoolToNullableBoolConverter.cs
│   ├── BoolToThreeStateConverter.cs
│   ├── IndeterminateToNullableBoolConverter.cs
│   ├── InvertBooleanConverter.cs
│   ├── InvertBooleanToVisibilityConverter.cs
│   ├── ScanStatusToColorConverter.cs
│   ├── StringToVisibilityConverter.cs
│   ├── StringToVisibilityConverterForError.cs
│   └── TagEqualsConverter.cs
│
├── Data/                         # 数据访问层（Repository模式）
│   ├── DatabaseContext.cs              # 数据库上下文
│   ├── AccountRepository.cs            # 账户数据访问
│   ├── AlarmRecordRepository.cs        # 报警记录数据访问
│   ├── DetectionLogRepository.cs       # 检测记录数据访问
│   ├── DetectionRoomRepository.cs      # 检测室数据访问
│   ├── LogisticsBoxRepository.cs       # 物流盒数据访问
│   ├── PermissionRepository.cs         # 权限数据访问
│   ├── PlcMonitorConfigRepository.cs   # PLC监控配置数据访问
│   ├── RoleRepository.cs               # 角色数据访问
│   ├── RuleRepository.cs               # 规则数据访问
│   └── I*.cs                          # 数据访问接口定义
│
├── Models/                       # 数据模型
│   ├── AlarmRecord.cs                 # 报警记录模型
│   ├── DetectionLogItem.cs            # 检测记录模型
│   ├── DetectionRoomItem.cs           # 检测室模型
│   ├── LogisticsBoxItem.cs            # 物流盒模型
│   ├── PermissionItem.cs              # 权限项模型
│   ├── PermissionModel.cs             # 权限模型
│   ├── PlcMonitorConfigItem.cs        # PLC监控配置模型
│   ├── RoleItem.cs                    # 角色模型
│   ├── RoomBoxList.cs                 # 检测室物流盒列表模型
│   ├── RuleItem.cs                    # 规则模型
│   ├── TaskItem.cs                    # 任务模型
│   └── UserItem.cs                    # 用户模型
│
├── Resources/                    # 资源文件
│   └── CommonStyles.xaml             # 通用样式定义
│
├── Services/                     # 业务逻辑层（Service模式）
│   ├── AccountService.cs             # 账户服务
│   ├── AlarmRecordService.cs         # 报警记录服务
│   ├── ApiHostService.cs             # API服务器托管服务
│   ├── CommunicationConfigService.cs # 通信配置服务
│   ├── CurrentUserService.cs         # 当前用户服务
│   ├── DetectionLogService.cs        # 检测记录服务
│   ├── DetectionRoomService.cs       # 检测室服务
│   ├── LogisticsBoxService.cs        # 物流盒服务
│   ├── PermissionService.cs          # 权限服务
│   ├── PlcMonitorConfigService.cs    # PLC监控配置服务
│   ├── RoleService.cs                # 角色服务
│   ├── RuleService.cs                # 规则服务
│   ├── S7CommunicationService.cs     # S7 PLC通信服务
│   ├── ScannerCommunicationService.cs # 串口扫码器通信服务
│   └── I*.cs                         # 服务接口定义
│
├── ViewModels/                   # 视图模型（MVVM）
│   ├── AccountManagementViewModel.cs        # 账户管理视图模型
│   ├── AddAccountDialogViewModel.cs         # 添加账户对话框视图模型
│   ├── AddDetectionRoomDialogViewModel.cs   # 添加检测室对话框视图模型
│   ├── AddLogisticsBoxDialogViewModel.cs    # 添加物流盒对话框视图模型
│   ├── AddRoleDialogViewModel.cs            # 添加角色对话框视图模型
│   ├── AddRuleDialogViewModel.cs            # 添加规则对话框视图模型
│   ├── CommunicationSettingsViewModel.cs    # 通信设置视图模型
│   ├── DetectionLogViewModel.cs             # 检测记录视图模型
│   ├── DetectionRoomManagementViewModel.cs  # 检测室管理视图模型
│   ├── DeviceAlarmViewModel.cs              # 设备报警视图模型
│   ├── LoginWindowViewModel.cs              # 登录窗口视图模型
│   ├── LogisticsBoxManagementViewModel.cs   # 物流盒管理视图模型
│   ├── MainWindowViewModel.cs               # 主窗口视图模型
│   ├── RoleManagementViewModel.cs           # 角色管理视图模型
│   ├── RuleManagementViewModel.cs           # 规则管理视图模型
│   └── TaskManagementViewModel.cs           # 任务管理视图模型
│
├── Views/                        # 视图（XAML界面）
│   ├── AccountManagementView.xaml           # 账户管理视图
│   ├── AddAccountDialog.xaml                # 添加账户对话框
│   ├── AddDetectionRoomDialog.xaml          # 添加检测室对话框
│   ├── AddLogisticsBoxDialog.xaml           # 添加物流盒对话框
│   ├── AddPlcMonitorConfigDialog.xaml       # 添加PLC监控配置对话框
│   ├── AddRoleDialog.xaml                   # 添加角色对话框
│   ├── AddRuleDialog.xaml                   # 添加规则对话框
│   ├── CommunicationSettingsView.xaml       # 通信设置视图
│   ├── CustomMessageBox.xaml                # 自定义消息框
│   ├── DetectionLogView.xaml                # 检测记录视图
│   ├── DetectionRoomManagementView.xaml     # 检测室管理视图
│   ├── DeviceAlarmView.xaml                 # 设备报警视图
│   ├── LoginWindow.xaml                     # 登录窗口
│   ├── LogisticsBoxManagementView.xaml      # 物流盒管理视图
│   ├── MainWindow.xaml                      # 主窗口
│   ├── RoleManagementView.xaml              # 角色管理视图
│   ├── RuleManagementView.xaml              # 规则管理视图
│   ├── TaskManagementView.xaml              # 任务管理视图
│   ├── ViewDetailDialog.xaml                # 查看详情对话框
│   ├── ViewPlcMonitorConfigDialog.xaml      # 查看PLC监控配置对话框
│   └── *.xaml.cs                            # 视图代码隐藏文件
│
├── Properties/                   # 项目属性
│   ├── AssemblyInfo.cs
│   ├── Resources.resx
│   └── Settings.settings
│
├── App.xaml                      # 应用程序入口XAML
├── App.xaml.cs                   # 应用程序入口代码（Prism引导程序）
├── App.config                    # 应用程序配置文件
└── ShunLiDuo.AutomationDetection.csproj  # 项目文件
```

---

## 3. 架构设计

### 3.1 整体架构

系统采用经典的三层架构模式：

```
┌─────────────────────────────────────────────────┐
│                   表示层 (Views)                 │
│  XAML界面 + ViewModels (MVVM模式)               │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│                业务逻辑层 (Services)             │
│  业务规则处理、权限验证、数据验证                │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│                数据访问层 (Data)                 │
│  Repository模式、SQLite数据库操作                │
└─────────────────────────────────────────────────┘
```

### 3.2 MVVM 模式

- **Model**: `Models/` 目录下的数据模型类
- **View**: `Views/` 目录下的 XAML 视图文件
- **ViewModel**: `ViewModels/` 目录下的视图模型类

视图与视图模型通过数据绑定（DataBinding）进行通信，使用 Prism 的 `ViewModelLocator` 实现自动绑定。

### 3.3 依赖注入

使用 **Prism.DryIoc** 作为依赖注入容器，在 `App.xaml.cs` 的 `RegisterTypes` 方法中注册所有服务和接口：

- **单例服务**: `DatabaseContext`（数据库上下文）
- **瞬态服务**: 所有 Repository 和 Service 接口实现
- **视图注册**: 所有 View 和 ViewModel 的注册

### 3.4 数据访问模式

采用 **Repository 模式**，每个实体都有对应的 Repository 接口和实现：

- `IRepository<T>` 接口定义基本 CRUD 操作
- `Repository<T>` 实现类提供具体的数据访问逻辑
- `DatabaseContext` 封装 SQLite 连接和数据库初始化

### 3.5 服务层模式

业务逻辑封装在 Service 层：

- **Service 接口** (`IService`) 定义服务契约
- **Service 实现** (`Service`) 提供具体业务逻辑
- Service 层调用 Repository 层进行数据操作
- Service 层处理业务规则、验证、权限检查等

---

## 4. 核心模块说明

### 4.1 任务管理模块 (`TaskManagementView`)

**功能**:
- 物流盒编码录入与任务分配
- 检测室状态实时监控
- PLC连接状态显示
- 串口扫码器连接状态显示
- 检测流程自动控制

**关键类**:
- `TaskManagementViewModel`: 任务管理业务逻辑
- `TaskItem`: 任务数据模型
- `RoomBoxList`: 检测室物流盒列表模型

**依赖服务**:
- `IRuleService`: 规则服务
- `IDetectionRoomService`: 检测室服务
- `IS7CommunicationService`: PLC通信服务
- `IScannerCommunicationService`: 串口扫码器服务
- `IDetectionLogService`: 检测记录服务
- `IAlarmRecordService`: 报警记录服务

### 4.2 规则管理模块 (`RuleManagementView`)

**功能**:
- 检测规则配置（物流盒编号与检测室匹配规则）
- 规则增删改查
- 规则验证

**关键类**:
- `RuleManagementViewModel`: 规则管理业务逻辑
- `RuleItem`: 规则数据模型
- `RuleService`: 规则服务
- `RuleRepository`: 规则数据访问

### 4.3 检测室管理模块 (`DetectionRoomManagementView`)

**功能**:
- 检测室基本信息管理
- 串口扫码器配置（串口号、波特率、数据位等）
- PLC地址配置（气缸控制地址、传感器地址等）
- 超时时间配置

**关键类**:
- `DetectionRoomManagementViewModel`: 检测室管理业务逻辑
- `DetectionRoomItem`: 检测室数据模型
- `DetectionRoomService`: 检测室服务

### 4.4 检测记录模块 (`DetectionLogView`)

**功能**:
- 检测历史记录查询
- 记录筛选（按物流盒编码、检测室、状态、时间）
- Excel导出功能

**关键类**:
- `DetectionLogViewModel`: 检测记录业务逻辑
- `DetectionLogItem`: 检测记录数据模型
- `DetectionLogService`: 检测记录服务

### 4.5 报警管理模块 (`DeviceAlarmView`)

**功能**:
- 设备报警记录查看
- 报警处理（标记为已处理）
- 报警记录筛选与查询
- 从报警信息中自动提取检测室名称

**关键类**:
- `DeviceAlarmViewModel`: 报警管理业务逻辑
- `AlarmRecord`: 报警记录数据模型
- `AlarmRecordService`: 报警记录服务

### 4.6 用户权限管理模块

#### 4.6.1 账户管理 (`AccountManagementView`)

**功能**:
- 用户账户增删改查
- 用户角色分配
- 密码管理

**关键类**:
- `AccountManagementViewModel`: 账户管理业务逻辑
- `UserItem`: 用户数据模型
- `AccountService`: 账户服务

#### 4.6.2 角色管理 (`RoleManagementView`)

**功能**:
- 角色增删改查
- 角色权限分配
- 管理员角色保护（不能删除，拥有全部权限）

**关键类**:
- `RoleManagementViewModel`: 角色管理业务逻辑
- `RoleItem`: 角色数据模型
- `RoleService`: 角色服务
- `PermissionService`: 权限服务

### 4.7 通信模块

#### 4.7.1 PLC通信 (`S7CommunicationService`)

**功能**:
- Siemens S7 PLC 连接管理
- 数据读取（Bool、Byte、Short、Int、Float）
- 数据写入（Bool）
- 连接状态监控

**技术**: S7.Net 库

#### 4.7.2 串口通信 (`ScannerCommunicationService`)

**功能**:
- 串口扫码器连接管理
- 扫码数据接收
- 多检测室串口管理
- 连接状态监控

**技术**: System.IO.Ports.SerialPort

### 4.8 API模块 (`Api/`)

**功能**:
- 提供 REST API 接口供外部系统（MES）调用
- 检测记录查询接口
- 任务状态查询与创建接口
- 自托管 HTTP 服务器

**关键类**:
- `ApiHostService`: API服务器托管服务
- `DetectionLogController`: 检测记录API控制器
- `TaskController`: 任务管理API控制器
- `HomeController`: 首页API控制器

**技术**: ASP.NET Web API SelfHost

**配置**: API地址可通过 `App.config` 中的 `ApiBaseAddress` 配置项设置

---

## 5. 数据库设计

### 5.1 数据库类型

**SQLite** - 轻量级嵌入式数据库

### 5.2 主要数据表

- **Rules**: 检测规则表
- **DetectionRooms**: 检测室配置表
- **LogisticsBoxes**: 物流盒表
- **Accounts**: 用户账户表
- **Roles**: 角色表
- **Permissions**: 权限表
- **RolePermissions**: 角色权限关联表
- **DetectionLogs**: 检测记录表
- **AlarmRecords**: 报警记录表
- **PlcMonitorConfigs**: PLC监控配置表

### 5.3 数据库初始化

在 `DatabaseContext.cs` 的 `InitializeDatabase` 方法中：
- 创建数据库表结构
- 初始化默认管理员角色（如果不存在）
- 初始化默认管理员用户（如果不存在）

---

## 6. 配置管理

### 6.1 应用程序配置 (`App.config`)

**主要配置项**:
- `ApiBaseAddress`: API服务器地址（默认: `http://localhost:8080`）

### 6.2 通信配置

- **PLC配置**: 存储在数据库的 `DetectionRooms` 表中
- **串口配置**: 存储在数据库的 `DetectionRooms` 表中

---

## 7. 权限系统

### 7.1 基于角色的访问控制 (RBAC)

- **用户 (User)**: 系统使用者
- **角色 (Role)**: 权限集合
- **权限 (Permission)**: 具体功能权限

### 7.2 权限检查

在 ViewModel 中使用 `ICurrentUserService.HasPermission` 方法检查权限：

```csharp
if (!_currentUserService.HasPermission("权限代码"))
{
    // 无权限处理
}
```

### 7.3 特殊角色

- **管理员角色**: 
  - 不能删除
  - 自动拥有全部权限
  - 创建时自动分配所有权限

---

## 8. 通信流程

### 8.1 物流盒检测流程

1. **录入物流盒编码** → `TaskManagementViewModel.AddLogisticsBoxCode`
2. **匹配规则** → 查找包含该物流盒编码的规则
3. **分配检测室** → 根据规则和检测室状态分配
4. **扫码检测** → 串口扫码器扫码触发检测流程
5. **PLC控制** → 根据扫码结果控制气缸动作
6. **记录日志** → 记录检测结果到数据库

### 8.2 PLC控制流程

1. **匹配流程** (扫码匹配成功):
   - 阻挡气缸收缩
   - 推箱气缸收缩
   - 检测完成

2. **不匹配流程** (扫码匹配失败):
   - 阻挡气缸收缩
   - 推箱气缸伸出
   - 检测完成

### 8.3 串口扫码流程

1. 串口数据接收 → `ScannerCommunicationService.DataReceived` 事件
2. 触发任务管理处理 → `TaskManagementViewModel.ScannerService_DataReceived`
3. 匹配规则并执行控制流程

---

## 9. API接口

### 9.1 检测记录接口 (`DetectionLogController`)

- `GET /api/detectionlog`: 获取所有检测记录
- `GET /api/detectionlog/{id}`: 根据ID获取检测记录
- `GET /api/detectionlog/box/{boxCode}`: 根据物流盒编码获取检测记录
- `GET /api/detectionlog/room/{roomId}`: 根据检测室ID获取检测记录
- `GET /api/detectionlog/status/{status}`: 根据状态获取检测记录
- `POST /api/detectionlog`: 创建检测记录

### 9.2 任务管理接口 (`TaskController`)

- `GET /api/task/status/{boxCode}`: 根据物流盒编码获取任务状态
- `POST /api/task/create`: 创建任务

### 9.3 首页接口 (`HomeController`)

- `GET /`: 获取API信息和接口列表

详细API文档请参考 `MES接口使用说明.md`

---

## 10. 异常处理

### 10.1 全局异常处理

在 `App.xaml.cs` 中：
- `DispatcherUnhandledException`: UI线程异常处理
- `AppDomain.CurrentDomain.UnhandledException`: 应用程序域异常处理
- PLC连接异常静默处理（避免频繁弹窗）

### 10.2 自定义消息框

使用 `CustomMessageBox` 替代 `MessageBox.Show`，提供统一的UI风格。

---

## 11. 启动流程

1. **应用程序启动** → `App.xaml.cs` `OnStartup`
2. **数据库初始化** → `InitializeDatabase`
3. **创建主窗口** → `CreateShell`
4. **显示登录窗口** → `LoginWindow.ShowDialog`
5. **登录验证** → `AccountService.LoginAsync`
6. **保存当前用户** → `ICurrentUserService.CurrentUser`
7. **自动连接PLC** → `AutoConnectPlcAsync`（如果启用）
8. **自动连接串口** → `AutoConnectAllScannersAsync`
9. **启动API服务器** → `ApiHostService.Start`
10. **显示主窗口** → `MainWindow.Show`

---

## 12. 开发规范

### 12.1 命名规范

- **类名**: PascalCase（如: `TaskManagementViewModel`）
- **方法名**: PascalCase（如: `AddLogisticsBoxCode`）
- **属性名**: PascalCase（如: `IsPlcConnected`）
- **私有字段**: camelCase 加下划线前缀（如: `_isPlcConnected`）
- **接口名**: I + PascalCase（如: `ITaskService`）

### 12.2 文件组织

- **一个类一个文件**: 每个类单独一个 `.cs` 文件
- **视图与代码隐藏分离**: `.xaml` 和 `.xaml.cs` 文件配对
- **按功能模块组织**: 相关文件放在同一目录下

### 12.3 代码风格

- **异步方法**: 使用 `async/await` 模式
- **数据绑定**: 使用 `BindableBase` 实现属性通知
- **命令**: 使用 `DelegateCommand` 或 `AsyncCommand`
- **依赖注入**: 通过构造函数注入依赖

---

## 13. 扩展说明

### 13.1 添加新功能模块

1. 创建 Model 类（`Models/`）
2. 创建 Repository 接口和实现（`Data/`）
3. 创建 Service 接口和实现（`Services/`）
4. 创建 ViewModel（`ViewModels/`）
5. 创建 View（`Views/`）
6. 在 `App.xaml.cs` 中注册依赖
7. 在主窗口中添加导航

### 13.2 添加新API接口

1. 在 `Api/Controllers/` 中创建 Controller
2. 在 `ApiHostService.cs` 中注册 Controller
3. 更新 API 文档

---

## 14. 依赖项

主要 NuGet 包：

- **Prism.DryIoc** (8.1.97): MVVM框架和依赖注入
- **MaterialDesignThemes** (4.9.0): Material Design UI组件
- **MaterialDesignColors** (2.1.4): Material Design颜色主题
- **S7netplus** (0.20.0): Siemens S7 PLC通信
- **System.Data.SQLite.Core** (1.0.118.0): SQLite数据库
- **Microsoft.AspNet.WebApi.SelfHost** (5.2.9): Web API自托管
- **ClosedXML** (0.102.2): Excel导出
- **Microsoft.Xaml.Behaviors.Wpf** (1.1.39): XAML行为

---

## 15. 相关文档

- `部署操作文档.md`: 部署和配置说明
- `MES接口使用说明.md`: REST API接口文档

---

## 16. 版本信息

- **.NET Framework版本**: 4.8
- **目标平台**: Windows
- **开发环境**: Visual Studio
- **架构**: x86/x64

---

**文档版本**: 1.0  
**最后更新**: 2025-01-09
