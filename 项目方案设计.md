# 顺利多自动化检测系统 - 项目方案设计

## 一、项目概述

### 1.1 项目名称
顺利多自动化检测系统

### 1.2 技术栈
- **框架**: WPF (Windows Presentation Foundation)
- **.NET版本**: .NET Framework 4.8
- **MVVM框架**: Prism 7.2+
- **数据库**: SQLite
- **ORM**: Entity Framework 6 或 Dapper
- **日志**: NLog 或 Serilog
- **依赖注入**: Prism内置IoC容器

### 1.3 项目目标
构建一个功能完善的自动化检测管理系统，实现任务管理、实时监控、设备管理、规则配置等核心功能。

---

## 二、功能模块分析

根据原型分析，系统包含以下8个主要功能模块：

1. **任务管理** - 检测任务的创建、分配、执行、查询
2. **检测室管理** - 检测室信息、设备配置管理
3. **物流盒管理** - 物流盒信息、流转管理
4. **规则管理** - 检测规则配置、规则引擎
5. **角色权限** - 用户角色、权限管理
6. **设备异常** - 设备异常记录、处理
7. **设备报警** - 设备报警信息、处理流程
8. **账户管理** - 用户账户管理

---

## 三、项目结构设计

### 3.1 解决方案结构

```
顺利多自动化检测系统/
├── ShunLiDuo.AutomationDetection.sln
│
├── ShunLiDuo.AutomationDetection.Shell/          # Shell主程序
│   ├── Views/
│   ├── ViewModels/
│   ├── App.xaml
│   └── MainWindow.xaml
│
├── ShunLiDuo.AutomationDetection.Infrastructure/ # 基础设施层
│   ├── Data/
│   │   ├── DatabaseContext.cs
│   │   └── Migrations/
│   ├── Logging/
│   ├── Configuration/
│   └── Extensions/
│
├── ShunLiDuo.AutomationDetection.Core/           # 核心业务层
│   ├── Models/                                   # 实体模型
│   ├── Interfaces/                               # 接口定义
│   ├── Services/                                 # 业务服务
│   └── Enums/                                    # 枚举定义
│
├── ShunLiDuo.AutomationDetection.Modules/        # 功能模块
│   ├── TaskManagement/                           # 任务管理模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── TaskManagementModule.cs
│   │
│   ├── DetectionRoomManagement/                   # 检测室管理模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── DetectionRoomManagementModule.cs
│   │
│   ├── LogisticsBoxManagement/                    # 物流盒管理模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── LogisticsBoxManagementModule.cs
│   │
│   ├── RuleManagement/                            # 规则管理模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── RuleManagementModule.cs
│   │
│   ├── RolePermission/                            # 角色权限模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── RolePermissionModule.cs
│   │
│   ├── DeviceException/                           # 设备异常模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── DeviceExceptionModule.cs
│   │
│   ├── DeviceAlarm/                                # 设备报警模块
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   ├── Services/
│   │   └── DeviceAlarmModule.cs
│   │
│   └── AccountManagement/                          # 账户管理模块
│       ├── Views/
│       ├── ViewModels/
│       ├── Services/
│       └── AccountManagementModule.cs
│
└── ShunLiDuo.AutomationDetection.Tests/           # 测试项目
    ├── UnitTests/
    └── IntegrationTests/
```

### 3.2 详细目录结构

#### Shell项目结构
```
ShunLiDuo.AutomationDetection.Shell/
├── App.xaml
├── App.xaml.cs
├── Bootstrapper.cs                    # Prism引导程序
├── MainWindow.xaml                    # 主窗口
├── MainWindow.xaml.cs
├── Views/
│   ├── ShellView.xaml                 # Shell视图
│   └── LoginView.xaml                 # 登录视图
├── ViewModels/
│   ├── ShellViewModel.cs
│   └── LoginViewModel.cs
├── Resources/
│   ├── Styles/
│   │   ├── MainStyles.xaml
│   │   └── Theme.xaml
│   └── Images/
└── Properties/
    └── AssemblyInfo.cs
```

#### Core项目结构
```
ShunLiDuo.AutomationDetection.Core/
├── Models/
│   ├── Task.cs                        # 任务实体
│   ├── DetectionRoom.cs               # 检测室实体
│   ├── LogisticsBox.cs                # 物流盒实体
│   ├── Rule.cs                        # 规则实体
│   ├── User.cs                        # 用户实体
│   ├── Role.cs                        # 角色实体
│   ├── Device.cs                      # 设备实体
│   ├── DeviceException.cs             # 设备异常实体
│   └── DeviceAlarm.cs                 # 设备报警实体
│
├── Interfaces/
│   ├── IRepository.cs                 # 仓储接口
│   ├── ITaskService.cs                # 任务服务接口
│   ├── IDetectionRoomService.cs
│   ├── ILogisticsBoxService.cs
│   ├── IRuleService.cs
│   ├── IUserService.cs
│   └── IDeviceService.cs
│
├── Services/
│   ├── TaskService.cs
│   ├── DetectionRoomService.cs
│   ├── LogisticsBoxService.cs
│   ├── RuleService.cs
│   ├── UserService.cs
│   └── DeviceService.cs
│
└── Enums/
    ├── TaskStatus.cs
    ├── DeviceStatus.cs
    ├── AlarmLevel.cs
    └── UserRole.cs
```

#### Infrastructure项目结构
```
ShunLiDuo.AutomationDetection.Infrastructure/
├── Data/
│   ├── DatabaseContext.cs             # EF DbContext
│   ├── Repositories/
│   │   ├── Repository.cs              # 通用仓储实现
│   │   ├── TaskRepository.cs
│   │   └── UserRepository.cs
│   └── Migrations/                     # 数据库迁移
│
├── Logging/
│   ├── Logger.cs
│   └── LoggingExtensions.cs
│
├── Configuration/
│   ├── AppSettings.cs
│   └── DatabaseConfig.cs
│
└── Extensions/
    ├── StringExtensions.cs
    └── DateTimeExtensions.cs
```

---

## 四、数据库设计

### 4.1 数据库表结构

#### 用户相关表
```sql
-- 用户表
CREATE TABLE Users (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    UserName TEXT NOT NULL UNIQUE,
    Password TEXT NOT NULL,
    RealName TEXT,
    Email TEXT,
    Phone TEXT,
    RoleId INTEGER,
    IsActive INTEGER DEFAULT 1,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdateTime DATETIME,
    FOREIGN KEY (RoleId) REFERENCES Roles(Id)
);

-- 角色表
CREATE TABLE Roles (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    RoleName TEXT NOT NULL UNIQUE,
    Description TEXT,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 权限表
CREATE TABLE Permissions (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    PermissionName TEXT NOT NULL UNIQUE,
    ModuleName TEXT,
    Description TEXT
);

-- 角色权限关联表
CREATE TABLE RolePermissions (
    RoleId INTEGER,
    PermissionId INTEGER,
    PRIMARY KEY (RoleId, PermissionId),
    FOREIGN KEY (RoleId) REFERENCES Roles(Id),
    FOREIGN KEY (PermissionId) REFERENCES Permissions(Id)
);
```

#### 任务相关表
```sql
-- 任务表
CREATE TABLE Tasks (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    TaskNo TEXT NOT NULL UNIQUE,
    TaskName TEXT NOT NULL,
    TaskType INTEGER,
    Status INTEGER DEFAULT 0,
    Priority INTEGER DEFAULT 0,
    DetectionRoomId INTEGER,
    LogisticsBoxId INTEGER,
    AssignedUserId INTEGER,
    StartTime DATETIME,
    EndTime DATETIME,
    CreateUserId INTEGER,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdateTime DATETIME,
    Remark TEXT,
    FOREIGN KEY (DetectionRoomId) REFERENCES DetectionRooms(Id),
    FOREIGN KEY (LogisticsBoxId) REFERENCES LogisticsBoxes(Id),
    FOREIGN KEY (AssignedUserId) REFERENCES Users(Id),
    FOREIGN KEY (CreateUserId) REFERENCES Users(Id)
);
```

#### 检测室相关表
```sql
-- 检测室表
CREATE TABLE DetectionRooms (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    RoomNo TEXT NOT NULL UNIQUE,
    RoomName TEXT NOT NULL,
    Location TEXT,
    Status INTEGER DEFAULT 1,
    Capacity INTEGER,
    Description TEXT,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdateTime DATETIME
);

-- 设备表
CREATE TABLE Devices (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    DeviceNo TEXT NOT NULL UNIQUE,
    DeviceName TEXT NOT NULL,
    DeviceType INTEGER,
    DetectionRoomId INTEGER,
    Status INTEGER DEFAULT 0,
    Manufacturer TEXT,
    Model TEXT,
    InstallDate DATETIME,
    LastMaintenanceDate DATETIME,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdateTime DATETIME,
    FOREIGN KEY (DetectionRoomId) REFERENCES DetectionRooms(Id)
);
```

#### 物流盒相关表
```sql
-- 物流盒表
CREATE TABLE LogisticsBoxes (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    BoxNo TEXT NOT NULL UNIQUE,
    BoxName TEXT NOT NULL,
    BoxType INTEGER,
    Status INTEGER DEFAULT 0,
    CurrentLocation TEXT,
    DetectionRoomId INTEGER,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdateTime DATETIME,
    Remark TEXT,
    FOREIGN KEY (DetectionRoomId) REFERENCES DetectionRooms(Id)
);
```

#### 规则相关表
```sql
-- 规则表
CREATE TABLE Rules (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    RuleNo TEXT NOT NULL UNIQUE,
    RuleName TEXT NOT NULL,
    RuleType INTEGER,
    RuleContent TEXT,
    IsActive INTEGER DEFAULT 1,
    Priority INTEGER DEFAULT 0,
    CreateUserId INTEGER,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdateTime DATETIME,
    FOREIGN KEY (CreateUserId) REFERENCES Users(Id)
);
```

#### 设备异常和报警表
```sql
-- 设备异常表
CREATE TABLE DeviceExceptions (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ExceptionNo TEXT NOT NULL UNIQUE,
    DeviceId INTEGER NOT NULL,
    ExceptionType INTEGER,
    ExceptionLevel INTEGER,
    Description TEXT,
    Status INTEGER DEFAULT 0,
    HandleUserId INTEGER,
    HandleTime DATETIME,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (DeviceId) REFERENCES Devices(Id),
    FOREIGN KEY (HandleUserId) REFERENCES Users(Id)
);

-- 设备报警表
CREATE TABLE DeviceAlarms (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    AlarmNo TEXT NOT NULL UNIQUE,
    DeviceId INTEGER NOT NULL,
    AlarmType INTEGER,
    AlarmLevel INTEGER,
    AlarmContent TEXT,
    Status INTEGER DEFAULT 0,
    HandleUserId INTEGER,
    HandleTime DATETIME,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (DeviceId) REFERENCES Devices(Id),
    FOREIGN KEY (HandleUserId) REFERENCES Users(Id)
);
```

#### 系统日志表
```sql
-- 操作日志表
CREATE TABLE OperationLogs (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    UserId INTEGER,
    ModuleName TEXT,
    OperationType TEXT,
    OperationContent TEXT,
    IpAddress TEXT,
    CreateTime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (UserId) REFERENCES Users(Id)
);
```

### 4.2 数据库初始化脚本

建议使用Entity Framework Code First方式，通过Migrations管理数据库版本。

---

## 五、Prism模块化设计

### 5.1 模块注册

每个功能模块都继承自`IModule`接口，在`Initialize`方法中注册服务和视图：

```csharp
public class TaskManagementModule : IModule
{
    private readonly IRegionManager _regionManager;
    private readonly IContainerProvider _containerProvider;

    public TaskManagementModule(IRegionManager regionManager, IContainerProvider containerProvider)
    {
        _regionManager = regionManager;
        _containerProvider = containerProvider;
    }

    public void OnInitialized(IContainerProvider containerProvider)
    {
        // 注册视图到区域
        _regionManager.RegisterViewWithRegion("MainContentRegion", typeof(TaskManagementView));
    }

    public void RegisterTypes(IContainerRegistry containerRegistry)
    {
        // 注册服务
        containerRegistry.Register<ITaskService, TaskService>();
        containerRegistry.Register<ITaskRepository, TaskRepository>();
        
        // 注册视图和ViewModel
        containerRegistry.RegisterForNavigation<TaskManagementView, TaskManagementViewModel>();
    }
}
```

### 5.2 区域定义

在Shell中定义主要区域：
- `MainContentRegion` - 主内容区域
- `MenuRegion` - 菜单区域
- `StatusBarRegion` - 状态栏区域
- `NavigationRegion` - 导航区域

---

## 六、MVVM架构设计

### 6.1 ViewModel基类

```csharp
public abstract class ViewModelBase : BindableBase, INavigationAware
{
    protected readonly IRegionManager _regionManager;
    protected readonly IEventAggregator _eventAggregator;

    public ViewModelBase(IRegionManager regionManager, IEventAggregator eventAggregator)
    {
        _regionManager = regionManager;
        _eventAggregator = eventAggregator;
    }

    public virtual void OnNavigatedTo(NavigationContext navigationContext) { }
    public virtual bool IsNavigationTarget(NavigationContext navigationContext) => true;
    public virtual void OnNavigatedFrom(NavigationContext navigationContext) { }
}
```

### 6.2 命令基类

使用Prism的`DelegateCommand`和`CompositeCommand`实现命令模式。

---

## 七、依赖注入配置

### 7.1 容器配置

在`Bootstrapper`中配置依赖注入：

```csharp
public class Bootstrapper : PrismBootstrapper
{
    protected override DependencyObject CreateShell()
    {
        return Container.Resolve<MainWindow>();
    }

    protected override void RegisterTypes(IContainerRegistry containerRegistry)
    {
        // 注册基础设施
        containerRegistry.RegisterSingleton<ILogger, NLogLogger>();
        containerRegistry.RegisterSingleton<IDatabaseContext, DatabaseContext>();
        
        // 注册服务
        containerRegistry.Register<ITaskService, TaskService>();
        // ... 其他服务注册
    }

    protected override void ConfigureModuleCatalog(IModuleCatalog moduleCatalog)
    {
        // 注册模块
        moduleCatalog.AddModule<TaskManagementModule>();
        // ... 其他模块
    }
}
```

---

## 八、开发规范

### 8.1 命名规范
- **类名**: PascalCase (如: `TaskService`)
- **方法名**: PascalCase (如: `GetTaskById`)
- **属性名**: PascalCase (如: `TaskName`)
- **私有字段**: _camelCase (如: `_taskService`)
- **局部变量**: camelCase (如: `taskId`)

### 8.2 文件组织
- 每个View和ViewModel放在同一文件夹
- 服务接口和实现分离
- 模型类按模块分组

### 8.3 代码规范
- 遵循C#编码规范
- 使用XML注释
- 异常处理要完善
- 异步操作使用async/await

---

## 九、开发计划

### 第一阶段：基础设施搭建（1-2周）
1. 创建解决方案和项目结构
2. 配置Prism框架
3. 设计数据库结构
4. 实现基础仓储和服务层
5. 创建Shell主框架

### 第二阶段：核心模块开发（3-4周）
1. 用户认证和权限模块
2. 任务管理模块
3. 检测室管理模块
4. 物流盒管理模块

### 第三阶段：扩展模块开发（2-3周）
1. 规则管理模块
2. 设备异常模块
3. 设备报警模块

### 第四阶段：测试和优化（1-2周）
1. 单元测试
2. 集成测试
3. 性能优化
4. Bug修复

---

## 十、技术要点

### 10.1 SQLite配置
- 使用System.Data.SQLite或Microsoft.Data.Sqlite
- 配置连接字符串
- 实现数据库迁移策略

### 10.2 日志记录
- 使用NLog记录操作日志
- 记录异常信息
- 记录性能数据

### 10.3 数据验证
- ViewModel中使用数据注解验证
- 实现自定义验证规则
- 提供友好的错误提示

### 10.4 异步操作
- 数据库操作使用异步方法
- UI操作使用异步避免阻塞
- 合理使用Task和async/await

---

## 十一、部署方案

### 11.1 打包方式
- 使用ClickOnce或MSI安装包
- 包含SQLite数据库文件
- 配置必要的依赖项

### 11.2 配置文件
- App.config存储连接字符串
- 支持多环境配置
- 敏感信息加密存储

---

## 十二、后续扩展

1. **数据导出**: Excel、PDF导出功能
2. **报表统计**: 数据统计和图表展示
3. **消息通知**: 系统消息和邮件通知
4. **移动端支持**: 考虑开发移动端应用
5. **云端同步**: 支持多客户端数据同步

---

## 附录

### A. 依赖包清单
- Prism.Wpf (7.2+)
- Prism.Unity 或 Prism.DryIoc
- EntityFramework (6.4+) 或 Dapper
- System.Data.SQLite 或 Microsoft.Data.Sqlite
- NLog 或 Serilog
- MaterialDesignThemes (可选，用于UI美化)

### B. 参考资料
- Prism官方文档: https://prismlibrary.com/
- WPF官方文档: https://docs.microsoft.com/wpf
- SQLite文档: https://www.sqlite.org/docs.html

