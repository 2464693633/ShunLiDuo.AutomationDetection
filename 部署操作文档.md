# 顺利多自动化检测系统 - 部署操作文档

## 概述

本文档详细说明顺利多自动化检测系统的打包、部署和配置步骤。本系统是一个基于 WPF 和 .NET Framework 4.8 的桌面应用程序，包含本地 SQLite 数据库和 HTTP REST API 服务。

## 目录

1. [系统要求](#系统要求)
2. [开发环境打包步骤](#开发环境打包步骤)
3. [现场部署步骤](#现场部署步骤)
4. [配置说明](#配置说明)
5. [验证部署](#验证部署)
6. [常见问题](#常见问题)
7. [卸载说明](#卸载说明)
8. [技术支持](#技术支持)

---

## 系统要求

### 最低系统要求

- **操作系统**：Windows 7 SP1 或更高版本（推荐 Windows 10/11）
- **.NET Framework**：4.8（必须）
- **内存**：4 GB RAM（推荐 8 GB）
- **磁盘空间**：至少 500 MB 可用空间
- **权限**：部署时需要管理员权限（用于配置 API 服务器）
- **网络**：如需使用 API 服务，需要网络访问权限

### 检查 .NET Framework 4.8

**方法1：通过控制面板检查**
1. 打开"控制面板" → "程序和功能"
2. 点击左侧"查看已安装的更新"
3. 查找 ".NET Framework 4.8"

**方法2：通过注册表检查**
```cmd
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" /v Release
```
如果返回值 >= 528040，则表示已安装 .NET Framework 4.8

**下载地址**（如未安装）：
https://dotnet.microsoft.com/download/dotnet-framework/net48

---

## 开发环境打包步骤

### 方法一：使用 Visual Studio（推荐）

1. **打开解决方案**
   - 在 Visual Studio 中打开 `ShunLiDuo.AutomationDetection.sln`

2. **选择 Release 配置**
   - 在顶部工具栏的配置下拉菜单中选择 `Release`
   - 确保平台选择为 `Any CPU`

3. **清理并构建项目**
   - 右键点击解决方案 → 选择"清理解决方案"
   - 右键点击解决方案 → 选择"重新生成解决方案"
   - 或者按快捷键：`Ctrl+Shift+B`

4. **验证构建结果**
   - 检查输出窗口，确保构建成功，无错误
   - 输出文件位置：`ShunLiDuo.AutomationDetection\bin\Release\`

### 方法二：使用 MSBuild 命令行

```cmd
cd "D:\Desktop\顺利多\客户端"
msbuild ShunLiDuo.AutomationDetection.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Clean,Build
```

### 准备部署文件

1. **定位 Release 文件夹**
   ```
   ShunLiDuo.AutomationDetection\bin\Release\
   ```

2. **需要复制的文件**
   - ✅ `ShunLiDuo.AutomationDetection.exe`（主程序）
   - ✅ `ShunLiDuo.AutomationDetection.exe.config`（配置文件，自动生成）
   - ✅ 所有 `.dll` 文件（依赖库，必须全部复制）
   - ✅ `AutomationDetection.db`（如果有现有数据库，建议包含）
   - ✅ `MES接口使用说明.md`（API 文档，可选）

3. **不需要复制的文件**
   - ❌ `*.pdb` 文件（调试符号文件）
   - ❌ `*.xml` 文件（XML 文档，可选）
   - ❌ `bin`、`obj` 文件夹

4. **创建部署包**
   建议的文件夹结构：
   ```
   部署包_v1.0/
   ├── ShunLiDuo.AutomationDetection.exe
   ├── ShunLiDuo.AutomationDetection.exe.config
   ├── [所有依赖的 .dll 文件]
   ├── AutomationDetection.db（如果有）
   ├── MES接口使用说明.md
   └── 部署操作文档.md（本文档）
   ```

---

## 现场部署步骤

### 第一步：准备工作

1. **确认系统要求**
   - 确认目标机器已安装 .NET Framework 4.8
   - 确认有足够的磁盘空间
   - 确认有管理员权限

2. **选择安装目录**
   - 推荐路径1：`D:\ShunLiDuo\AutomationDetection`
   - 推荐路径2：`C:\Program Files\ShunLiDuo\AutomationDetection`
   - 推荐路径3：`C:\AutomationDetection`
   - **注意**：避免使用中文路径和特殊字符

### 第二步：复制文件

1. **创建安装目录**
   - 在目标机器上创建安装文件夹

2. **复制部署包**
   - 将部署包中的所有文件复制到安装目录
   - 确保所有 `.dll` 文件都在同一目录下
   - 确保 `ShunLiDuo.AutomationDetection.exe.config` 存在

3. **检查文件完整性**
   - 确认主程序文件存在
   - 确认所有依赖 DLL 文件已复制（通常有 30-50 个 DLL 文件）
   - 确认配置文件存在

### 第三步：配置 API 服务器（重要）

如果系统需要提供 HTTP API 服务（供 MES 系统调用），必须配置 URL ACL 权限。

**方法1：使用 netsh 命令（推荐）**

1. **以管理员身份运行 PowerShell 或 CMD**
   - 右键点击"开始"菜单
   - 选择"Windows PowerShell (管理员)"或"命令提示符 (管理员)"

2. **执行配置命令**
   ```cmd
   netsh http add urlacl url=http://+:8080/ user=Everyone
   ```

3. **验证配置**
   ```cmd
   netsh http show urlacl
   ```
   应该能看到 `http://+:8080/` 的配置项

4. **如需删除配置（重新配置时）**
   ```cmd
   netsh http delete urlacl url=http://+:8080/
   ```

**方法2：使用管理员身份运行程序（不推荐）**
- 右键点击 `ShunLiDuo.AutomationDetection.exe`
- 选择"以管理员身份运行"
- **注意**：此方法每次运行都需要管理员权限，不建议用于生产环境

### 第四步：创建桌面快捷方式（可选）

1. **创建快捷方式**
   - 右键点击 `ShunLiDuo.AutomationDetection.exe`
   - 选择"发送到" → "桌面快捷方式"

2. **重命名快捷方式**
   - 将快捷方式重命名为"顺利多自动化检测系统"

3. **设置图标（可选）**
   - 右键点击快捷方式 → "属性" → "更改图标"

### 第五步：首次运行

1. **启动程序**
   - 双击 `ShunLiDuo.AutomationDetection.exe` 或使用快捷方式

2. **数据库初始化**
   - 首次运行会自动创建数据库文件 `AutomationDetection.db`
   - 自动创建数据库表结构
   - 自动创建默认管理员账户

3. **默认管理员账户**
   - **用户名**：`admin`
   - **密码**：`123`
   - **提示**：首次登录后请立即修改密码

4. **登录系统**
   - 使用默认管理员账户登录
   - 进入系统后，建议：
     - 修改管理员密码
     - 配置 PLC 连接参数（如需要）
     - 配置串口扫描器参数（如需要）
     - 创建其他用户账户（如需要）

---

## 配置说明

### 数据库配置

- **数据库文件位置**：与主程序同目录下的 `AutomationDetection.db`
- **数据库类型**：SQLite（嵌入式数据库，无需额外安装）
- **备份建议**：定期备份 `AutomationDetection.db` 文件
- **迁移说明**：如需迁移数据，直接复制 `AutomationDetection.db` 文件即可

### API 服务器配置

- **默认端口**：8080
- **默认地址**：`http://localhost:8080`
- **修改端口**：需要修改源代码中 `App.xaml.cs` 的 `ApiHostService` 构造函数参数，重新编译
- **外部访问**：默认只允许本地访问，如需外部访问：
  1. 修改防火墙规则，允许端口 8080（TCP）
  2. 修改代码中的地址从 `localhost` 改为 `+` 或具体 IP 地址

### 应用程序配置

配置文件：`ShunLiDuo.AutomationDetection.exe.config`

**重要配置项**：
- `.NET Framework` 版本：v4.8（必须）
- 程序集绑定重定向：自动配置，通常不需要修改

**修改配置**：
- 使用文本编辑器（如记事本）打开配置文件
- 修改后保存，需要重启应用程序生效

### 防火墙配置（如需要外部访问 API）

1. **打开 Windows 防火墙**
   - 控制面板 → 系统和安全 → Windows Defender 防火墙
   - 点击"高级设置"

2. **添加入站规则**
   - 点击"入站规则" → "新建规则"
   - 选择"端口" → "下一步"
   - 选择"TCP"，输入"8080" → "下一步"
   - 选择"允许连接" → "下一步"
   - 勾选所有配置文件 → "下一步"
   - 输入规则名称："顺利多API服务端口8080" → "完成"

---

## 验证部署

### 基本功能验证

1. **程序启动**
   - [ ] 双击程序，能正常启动
   - [ ] 登录窗口正常显示
   - [ ] 使用默认账户（admin/123）能成功登录

2. **数据库功能**
   - [ ] 登录后能正常进入主界面
   - [ ] 数据库文件 `AutomationDetection.db` 已创建
   - [ ] 各个功能模块能正常打开

3. **API 服务器验证**
   - [ ] 浏览器访问：`http://localhost:8080/`
   - [ ] 应显示 JSON 格式的 API 信息
   - [ ] 不应出现 404 或连接错误

### API 功能测试

**测试1：获取 API 信息**
```
GET http://localhost:8080/
```
应返回 JSON 格式的 API 信息

**测试2：获取检测记录**
```
GET http://localhost:8080/api/detectionlog
```
应返回 JSON 格式的检测记录数据（可能为空数组）

**测试3：查询任务状态**
```
GET http://localhost:8080/api/task/status/物流盒编码001
```
应返回 JSON 格式的响应

**测试工具**：
- 浏览器（用于 GET 请求）
- Postman
- curl 命令
- C# HttpClient
- Python requests

详细 API 文档请参考：`MES接口使用说明.md`

### 功能模块验证

1. **账户管理**
   - [ ] 能创建新账户
   - [ ] 能修改账户信息
   - [ ] 能删除账户（非管理员账户）

2. **角色管理**
   - [ ] 能创建新角色
   - [ ] 能分配权限
   - [ ] 管理员角色不能被删除

3. **检测室管理**
   - [ ] 能创建检测室
   - [ ] 能修改检测室信息
   - [ ] 能删除检测室

4. **物流盒管理**
   - [ ] 能创建物流盒
   - [ ] 能修改物流盒信息
   - [ ] 能删除物流盒

5. **规则管理**
   - [ ] 能创建规则
   - [ ] 能修改规则
   - [ ] 能删除规则

6. **检测记录**
   - [ ] 能查看检测记录
   - [ ] 能导出 Excel（如有数据）

7. **通信设置**
   - [ ] 能配置 PLC 连接参数
   - [ ] 能配置串口扫描器参数
   - [ ] 能测试连接

---

## 常见问题

### 问题1：程序无法启动

**症状**：双击程序无反应或提示错误

**可能原因及解决方案**：

1. **缺少 .NET Framework 4.8**
   - 检查是否已安装 .NET Framework 4.8
   - 下载并安装：https://dotnet.microsoft.com/download/dotnet-framework/net48

2. **缺少依赖 DLL**
   - 确认所有 DLL 文件都已复制到程序目录
   - 检查是否有 DLL 文件缺失或被删除

3. **权限问题**
   - 尝试以管理员身份运行
   - 检查程序目录是否有写入权限

### 问题2：API 服务器启动失败

**症状**：程序启动后，访问 `http://localhost:8080/` 失败

**可能原因及解决方案**：

1. **URL ACL 未配置**
   - 执行：`netsh http add urlacl url=http://+:8080/ user=Everyone`
   - 需要管理员权限

2. **端口被占用**
   - 检查端口占用：`netstat -ano | findstr :8080`
   - 关闭占用端口的程序，或修改 API 端口（需要修改代码重新编译）

3. **权限不足**
   - 确认 URL ACL 配置正确
   - 尝试以管理员身份运行程序

### 问题3：数据库错误

**症状**：程序启动后提示数据库错误

**可能原因及解决方案**：

1. **数据库文件损坏**
   - 备份当前数据库文件
   - 删除 `AutomationDetection.db` 文件
   - 重新启动程序，会自动创建新数据库
   - 如需要恢复数据，可使用备份文件

2. **数据库文件被占用**
   - 关闭其他可能访问数据库的程序
   - 检查是否有其他程序实例正在运行

3. **磁盘空间不足**
   - 检查安装目录所在磁盘的可用空间
   - 清理磁盘空间

### 问题4：登录失败

**症状**：使用默认账户无法登录

**可能原因及解决方案**：

1. **账户不存在**
   - 首次运行会自动创建管理员账户
   - 如果账户不存在，删除数据库文件重新初始化

2. **密码错误**
   - 默认密码：`123`
   - 确认输入正确（区分大小写）
   - 如果已修改密码，使用新密码登录

### 问题5：PLC 连接失败

**症状**：无法连接到 PLC

**可能原因及解决方案**：

1. **网络连接问题**
   - 检查网络连接
   - 使用 ping 命令测试 PLC IP 地址
   - 检查防火墙设置

2. **参数配置错误**
   - 检查 PLC IP 地址、CPU 类型、机架号、槽位号
   - 确认参数与 PLC 实际配置一致

3. **PLC 未启动或故障**
   - 检查 PLC 电源和状态
   - 使用其他工具测试 PLC 连接

### 问题6：串口连接失败

**症状**：无法连接到串口扫描器

**可能原因及解决方案**：

1. **串口被占用**
   - 检查是否有其他程序占用串口
   - 关闭占用串口的程序

2. **参数配置错误**
   - 检查串口号、波特率、数据位、停止位、校验位
   - 确认参数与扫描器配置一致

3. **硬件问题**
   - 检查串口线连接
   - 检查扫描器电源和状态
   - 尝试更换串口线

### 问题7：无法导出 Excel

**症状**：点击导出 Excel 按钮无反应或报错

**可能原因及解决方案**：

1. **无数据可导出**
   - 确认有检测记录数据

2. **文件权限问题**
   - 检查保存目录的写入权限
   - 尝试保存到其他目录（如桌面）

3. **文件被占用**
   - 确认目标 Excel 文件未被其他程序打开
   - 关闭 Excel 或其他可能占用文件的程序

---

## 卸载说明

### 卸载步骤

1. **停止程序**
   - 关闭所有正在运行的程序实例
   - 确认任务管理器中无相关进程

2. **备份数据（重要）**
   - 备份 `AutomationDetection.db` 数据库文件
   - 备份配置文件（如有自定义配置）

3. **删除文件**
   - 删除整个安装目录
   - 如果安装在 `C:\Program Files` 下，可能需要管理员权限

4. **删除快捷方式**
   - 删除桌面快捷方式
   - 删除开始菜单快捷方式（如有）

5. **清理 URL ACL 配置（如需要）**
   ```cmd
   netsh http delete urlacl url=http://+:8080/
   ```
   需要管理员权限

6. **清理防火墙规则（如需要）**
   - 打开 Windows 防火墙高级设置
   - 删除之前添加的端口 8080 规则

**注意**：
- 卸载不会影响 Windows 系统文件
- 卸载不会卸载 .NET Framework 4.8
- 建议保留数据库文件备份，以备将来需要

---

## 技术支持

### 联系方式

- **技术支持**：[填写联系方式]
- **文档版本**：v1.0
- **最后更新**：2024年

### 相关文档

- `MES接口使用说明.md` - API 接口详细文档
- 源代码文档（如有）

### 版本历史

- **v1.0**（2024年）- 初始版本

---

## 附录

### 附录A：文件清单

典型的 Release 版本包含以下主要 DLL 文件：

- `ShunLiDuo.AutomationDetection.exe` - 主程序
- `ShunLiDuo.AutomationDetection.exe.config` - 配置文件
- `DryIoc.dll` - IoC 容器
- `Prism.DryIoc.Wpf.dll` - Prism 框架
- `Prism.Wpf.dll` - Prism WPF 支持
- `System.Data.SQLite.dll` - SQLite 数据库驱动
- `S7netplus.dll` - 西门子 S7 PLC 通信库
- `MaterialDesignThemes.Wpf.dll` - Material Design UI 库
- `MaterialDesignColors.dll` - Material Design 颜色库
- `Newtonsoft.Json.dll` - JSON 序列化库
- `ClosedXML.dll` - Excel 操作库
- 以及其他依赖库（通常 30-50 个 DLL 文件）

**注意**：所有 DLL 文件都必须复制到部署目录，缺少任何文件都可能导致程序无法运行。

### 附录B：命令参考

**检查 .NET Framework 版本**
```cmd
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" /v Release
```

**检查端口占用**
```cmd
netstat -ano | findstr :8080
```

**查看 URL ACL 配置**
```cmd
netsh http show urlacl
```

**添加 URL ACL 配置**
```cmd
netsh http add urlacl url=http://+:8080/ user=Everyone
```

**删除 URL ACL 配置**
```cmd
netsh http delete urlacl url=http://+:8080/
```

**测试 API 连接（使用 curl）**
```cmd
curl http://localhost:8080/
curl http://localhost:8080/api/detectionlog
```

### 附录C：快速检查清单

部署完成后，使用以下清单快速验证：

- [ ] .NET Framework 4.8 已安装
- [ ] 所有文件已复制到安装目录
- [ ] URL ACL 已配置（如需要 API 服务）
- [ ] 程序能正常启动
- [ ] 可以使用默认账户登录（admin/123）
- [ ] API 服务器能正常访问（如需要）
- [ ] 数据库文件已创建
- [ ] 各个功能模块能正常打开
- [ ] 已修改默认管理员密码
- [ ] 已创建桌面快捷方式（可选）

---

**文档结束**

